const axios = require('axios');\nconst fs = require('fs');\nconst path = require('path');\nconst https = require('https');\n\n// --- Configuration ---\nconst CHANNELS = [\n    // Cricket\n    \"https://v1.crichd.tv/sky-sports-cricket-live-stream-me-1\",\n    \"https://v1.crichd.tv/willow-cricket-live-stream-play-01\",\n    \"https://v1.crichd.tv/star-sports-1-live-stream-play-01\",\n    \"https://v1.crichd.tv/ptv-sports-live-stream-play-01\",\n    \"https://v1.crichd.tv/ten-sports-live-stream-play-01\",\n    \"https://v1.crichd.tv/a-sports-hd-live-streaming-play-01\",\n    \"https://v1.crichd.tv/fox-cricket-501-live-stream-play-01\",\n    \"https://v1.crichd.tv/supersport-cricket-live-stream-play-01\",\n    \n    // UK Sports\n    \"https://v1.crichd.tv/sky-sports-main-event-live-stream-play3\",\n    \"https://v1.crichd.tv/sky-sports-premier-league-live-stream-play3\",\n    \"https://v1.crichd.tv/sky-sports-football-live-stream-play3\",\n    \"https://v1.crichd.tv/sky-sports-f1-live-streaming-f17\",\n    \"https://v1.crichd.tv/tnt-sports-1-live-stream-uk-01\",\n    \"https://v1.crichd.tv/tnt-sports-2-live-stream-uk-01\",\n    \"https://v1.crichd.tv/tnt-sports-3-live-stream-uk-01\",\n    \"https://v1.crichd.tv/tnt-sports-4-live-stream-uk-01\",\n\n    // US Sports\n    \"https://v1.crichd.tv/espn-us-live-stream-play\",\n    \"https://v1.crichd.tv/espn-2-us-live-stream-play\",\n];\n\nconst agent = new https.Agent({\n    rejectUnauthorized: false // Disables SSL certificate verification\n});\n\n// --- Core Functions ---\n\nasync function getPageContent(url, headers = {}) {\n    try {\n        const response = await axios.get(url, { \n            headers, \n            httpsAgent: agent,\n            timeout: 20000 \n        });\n        return response.data;\n    } catch (error) {\n        console.error(`    [!] Error fetching ${url}: ${error.message}`);\n        return null;\n    }\n}\n\nasync function extractStreamDetails(channelUrl) {\n    console.log(`[1] Processing Channel: ${channelUrl}`);\n    \n    // Step 1: Get title and the initial iframe from the main channel page\n    const mainContent = await getPageContent(channelUrl);\n    if (!mainContent) return { m3u8Link: null, title: null };\n\n    const titleMatch = mainContent.match(/<h1.*?>(.*?)<\\/h1>/);\n    const title = titleMatch ? titleMatch[1].trim() : path.basename(channelUrl);\n\n    const iframeMatch = mainContent.match(/<iframe src=\"(\\/\\/streamcrichd.com\\/[^\"]+)\"/);\n    if (!iframeMatch) {\n        console.log(\"    [!] Could not find streamcrichd.com iframe.\");\n        return { m3u8Link: null, title };\n    }\n\n    const streamcrichdUrl = \"https\" + iframeMatch[1];\n    console.log(`    [>] Found streamcrichd URL: ${streamcrichdUrl}`);\n\n    // Step 2: Get the 'fid' from the streamcrichd page\n    const streamcrichdContent = await getPageContent(streamcrichdUrl, { 'Referer': 'https://v1.crichd.tv/' });\n    if (!streamcrichdContent) return { m3u8Link: null, title };\n\n    const fidMatch = streamcrichdContent.match(/fid=\"([^\"]+)\"/);\n    if (!fidMatch) {\n        console.log(\"    [!] Could not find 'fid' on streamcrichd page.\");\n        return { m3u8Link: null, title };\n    }\n    const fid = fidMatch[1];\n    console.log(`    [>] Found fid: ${fid}`);\n\n    // Step 3: Get the final obfuscated script from the profamouslife page\n    const profamouslifeUrl = `https://profamouslife.com/premium.php?player=desktop&live=${fid}`;\n    const profamouslifeContent = await getPageContent(profamouslifeUrl, { 'Referer': 'https://streamcrichd.com/' });\n    if (!profamouslifeContent) return { m3u8Link: null, title };\n\n    // Step 4: The Golden Regex - Extract the character array for the m3u8 link\n    const m3u8PartsMatch = profamouslifeContent.match(/return\\(\\[([^\\]]+)\\]\\.join/);\n    if (!m3u8PartsMatch) {\n        console.log(\"    [!] FATAL: Could not find the obfuscated m3u8 array.\");\n        return { m3u8Link: null, title };\n    }\n\n    const urlPartsStr = m3u8PartsMatch[1];\n    const urlChars = urlPartsStr.split(',').map(part => part.trim().replace(/\"|'/g, '').replace(/\\\\\\//g, '/'));\n    let finalM3u8Url = urlChars.join('');\n    finalM3u8Url = finalM3u8Url.replace(/:\\/+/g, '://');\n\n    console.log(`    [+] SUCCESS: Extracted M3U8 link: ${finalM3u8Url}`);\n    return { m3u8Link: finalM3u8Url, title };\n}\n\n// --- Main Execution ---\n\nasync function main() {\n    const m3uHeader = \"#EXTM3U\";\n    const playlistEntries = [];\n\n    console.log(\"--- Starting CricHD Channel Scraper (Node.js) ---\");\n\n    for (const channelUrl of CHANNELS) {\n        const { m3u8Link, title } = await extractStreamDetails(channelUrl);\n        if (m3u8Link && title) {\n            const entry = `#EXTINF:-1 tvg-id=\"${title}\" group-title=\"CricHD\",${title}\\n${m3u8Link}`;\n            playlistEntries.push(entry);\n        }\n        console.log(\"-\".repeat(40));\n    }\n\n    if (playlistEntries.length === 0) {\n        console.log(\"No stream links were found. The playlist will be empty.\");\n        fs.writeFileSync('crichd_playlist.m3u', m3uHeader, 'utf-8');\n    } else {\n        const finalPlaylist = `${m3uHeader}\\n\\n${playlistEntries.join('\\n\\n')}`;\n        fs.writeFileSync('crichd_playlist.m3u', finalPlaylist, 'utf-8');\n        console.log(`\\n--- Playlist Generation Complete! ---\`);\n        console.log(`Successfully wrote ${playlistEntries.length} channels to crichd_playlist.m3u`);\n    }\n}\n\nmain();\n